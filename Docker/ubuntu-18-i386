FROM ubuntu:bionic@sha256:fc896f56642f382e99601461c683dee1534f0d4cb7e17bcb3494d5ed0f3a8a06

ARG VERSION
ARG BUTLER
ARG PATH

ENV BUTLER_API_KEY=${BUTLER}

RUN apt-get -qq update && apt-get -qq install -y sudo unzip chmod curl wget sh clang libspeechd-dev pkg-config libssl-dev alsa librust-alsa-sys-dev

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

RUN echo 'source $HOME/.cargo/env' >> $HOME/.bashrc

RUN mkdir cacophony

WORKDIR cacophony

COPY ../Cargo.lock Cargo.lock

COPY ../Cargo.toml Cargo.toml

RUN mkdir audio

RUN mkdir common

RUN mkdir data

RUN mkdir input

RUN mkdir io

RUN mkdir render

RUN mkdir src

RUN mkdir text

COPY ../audio audio/

COPY ../common common/

COPY ../data data

COPY ../input input

COPY ../io io

COPY ../render render

COPY ../src src

COPY ../text text

RUN cargo build --release

RUN mkdir -p cacophony/data

RUN cp target/release/cacophony cacophony/cacophony 

RUN cp -R data cacophony

RUN wget -O butler.zip https://broth.itch.ovh/butler/linux-386/LATEST/archive/default

RUN unzip butler.zip

RUN chmod +x butler

RUN ./butler login

RUN ./butler push cacophony subalterngames/cacophony:ubuntu18-i386 --userversion=${VERSION}